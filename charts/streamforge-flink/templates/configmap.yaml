apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-flink-config
  labels:
    app: {{ .Release.Name }}
    component: flink
data:
  flink-conf.yaml: |
    jobmanager.rpc.address: {{ .Release.Name }}-jobmanager
    jobmanager.rpc.port: 6123
    jobmanager.memory.process.size: {{ .Values.jobmanager.resources.limits.memory }}
    taskmanager.memory.process.size: {{ .Values.taskmanager.resources.limits.memory }}
    taskmanager.numberOfTaskSlots: {{ .Values.taskmanager.taskSlots }}
    parallelism.default: {{ mul .Values.taskmanager.replicas .Values.taskmanager.taskSlots }}
    
    # Checkpointing
    {{- if .Values.checkpointing.enabled }}
    execution.checkpointing.interval: {{ .Values.checkpointing.interval }}
    state.backend: {{ .Values.checkpointing.stateBackend }}
    state.checkpoints.dir: {{ .Values.checkpointing.storagePath }}
    state.savepoints.dir: {{ .Values.savepoints.storagePath }}
    {{- end }}
    
    # High availability (optional)
    # high-availability: zookeeper
    
    # Metrics
    {{- if .Values.metrics.enabled }}
    metrics.reporters: prom
    metrics.reporter.prom.factory.class: org.apache.flink.metrics.prometheus.PrometheusReporterFactory
    metrics.reporter.prom.port: {{ .Values.metrics.port }}
    {{- end }}
    
  log4j-console.properties: |
    rootLogger.level = INFO
    rootLogger.appenderRef.console.ref = ConsoleAppender
    appender.console.name = ConsoleAppender
    appender.console.type = CONSOLE
    appender.console.layout.type = PatternLayout
    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
